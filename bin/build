#!/bin/sh
# @author: Daniel (dmilith) Dettlaff (dmilith@verknowsys.com)


# load configuration from sofin.conf
CONF_FILE="sofin.conf.sh"
if [ -e "src/${CONF_FILE}" ]; then
    . "src/${CONF_FILE}"
    echo "Validating environment"
    validate_env
else
    echo "FATAL: No configuration file found: ${CONF_FILE}"
    exit 1
fi

# choose C compiler, if any
export CXX="/usr/bin/g++"
if [ -x "/usr/bin/clang++" ]; then
    export CXX="/usr/bin/clang++"
fi
if [ ! -x "${CXX}" ]; then
    error "C++ compiler is required to install Sofin"
    exit 1
fi

readonly CLANG_OPTIONS="-Os -fPIC -fPIE"

shell_configuration=$(${CAT_BIN} <<EOF
if [ "\$(${ID_BIN} -u)" = "0" ]; then
    if [ -e "/etc/profile_sofin" ]; then
        . /etc/profile_sofin
    fi
    trap "source /etc/profile_sofin" USR2
else
    if [ -e \$HOME/.profile ]; then
        . \$HOME/.profile
    fi
    trap "source \$HOME/.profile" USR2
fi
export SHELL_PID="\$\$"
EOF
)


update_env_files () {
    env_files="/etc/zshenv /etc/bashrc /etc/profile"
    for i in ${env_files}; do
        if [ -f "${i}" ]; then
            ${GREP_BIN} -q "SHELL_PID" "${i}"
            if [ $? -eq 0 ]; then
                continue
            else
                echo "Updating environment file: ${i}"
                echo "${shell_configuration}" >> "${i}"
                check_command_result $?
            fi
        else
            echo "Creating environment file: ${i}"
            echo "${shell_configuration}" >> "${i}"
            check_command_result $?
        fi
    done
}


# create_user_symlinks () {
#     if [ ! -d "${HOME_DIR}" ]; then
#         echo "Creating ${HOME_DIR} directory."
#         ${MKDIR_BIN} "${HOME_DIR}"
#         check_command_result $?
#     fi

#     CWD="$(pwd)"
#     cd /home

#     for i in *; do
#         uid="$(id -u $i 2>/dev/null)"
#         if [ ! $uid ]; then
#             continue
#         fi
#         if [ ! -L "${HOME_DIR}${uid}" ]; then
#             echo "Creating symlink ${HOME_DIR}${uid} -> /home/${i}."
#             ${LN_BIN} -s "/home/${i}" "${HOME_DIR}${uid}"
#             check_command_result $?
#         fi
#     done

#     cd "${CWD}"
# }


install_base () {
    build_natives

    if [ "${INSTALL}" = "YES" ]; then
        check_root
        ${RM_BIN} -rf "${PREFIX}/usr/bin/sofin"
        # if [ "$(uname)" != "Darwin" ]; then
        #     ${RM_BIN} -rf "/usr/bin/sofin-rpp"
        # fi
        ${RM_BIN} -rf "${PREFIX}/usr/bin/sofin-version-utility"
        ${RM_BIN} -rf "${PREFIX}/usr/bin/sofin-microseconds"
        ${RM_BIN} -rf "${PREFIX}/etc/${CONF_FILE}"
        install_sofin
    fi
}


build_natives () {
    if [ -x "${CXX}" ]; then
        echo "C++ compiler available. Using: ${CXX}"

        echo "Building sofin_microseconds"
        ${CXX} ${CLANG_OPTIONS} -o bin/sofin-microseconds src/sofin_microseconds.cc
        check_command_result $?

        echo "Building version utility"
        ${CXX} ${CLANG_OPTIONS} -o bin/sofin-version-utility src/sofin-version-utility.cc
        check_command_result $?

        if [ "$(uname)" = "Darwin" ]; then
            echo "Building dylibbundler"
            ${CXX} ${CLANG_OPTIONS} -c -I./src/dylibbundler ./src/dylibbundler/Settings.cpp -o src/.Settings.o
            ${CXX} ${CLANG_OPTIONS} -c -I./src/dylibbundler ./src/dylibbundler/DylibBundler.cpp -o src/.DylibBundler.o
            ${CXX} ${CLANG_OPTIONS} -c -I./src/dylibbundler ./src/dylibbundler/Dependency.cpp -o src/.Dependency.o
            ${CXX} ${CLANG_OPTIONS} -c -I./src/dylibbundler ./src/dylibbundler/main.cpp -o src/.main.o
            ${CXX} ${CLANG_OPTIONS} -c -I./src/dylibbundler ./src/dylibbundler/Utils.cpp -o src/.Utils.o
            ${CXX} ${CLANG_OPTIONS} -o bin/sofin-dylibbundler src/.Settings.o src/.DylibBundler.o src/.Dependency.o src/.main.o src/.Utils.o
        fi
    else
        error "C++ compiler is required to continue"
        exit 1
    fi
}


install_sofin () {
    if [ "${PREFIX}" != "" ]; then
        ${MKDIR_BIN} -p "${PREFIX}" "${PREFIX}/etc" "${PREFIX}/usr/bin"
    fi
    ${CP_BIN} "src/${CONF_FILE}" "${PREFIX}/etc/${CONF_FILE}"
    check_command_result $?
    if [ "$(uname)" = "Darwin" ]; then
        ${CP_BIN} "bin/sofin-dylibbundler" "${PREFIX}/usr/bin/sofin-dylibbundler"
        check_command_result $?
    fi
    ${CP_BIN} "bin/sofin-version-utility" ${PREFIX}/usr/bin/sofin-version-utility
    check_command_result $?
    ${CP_BIN} "bin/sofin-microseconds" ${PREFIX}/usr/bin/sofin-microseconds
    check_command_result $?
    ${CP_BIN} "src/sofin.sh" ${PREFIX}/usr/bin/sofin
    check_command_result $?

    sofin_version=$(${CAT_BIN} src/sofin.sh | ${GREP_BIN} VERSION= | ${AWK_BIN} '{print $2}')
    echo "Sofin ${sofin_version} installed"
}


update_env_files
install_base
