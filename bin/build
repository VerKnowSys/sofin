#!/bin/sh
# @author: Daniel (dmilith) Dettlaff (dmilith@verknowsys.com)


# load configuration from sofin.conf
CONF_FILE="sofin.conf.sh"
if [ -e "src/${CONF_FILE}" ]; then
    . "src/${CONF_FILE}"
    echo "Validating environment"
    validate_env
else
    echo "FATAL: No configuration file found: ${CONF_FILE}"
    exit 1
fi

# choose C compiler, if any
export CXX="/usr/bin/g++"
if [ -x "/usr/bin/clang++" ]; then
    export CXX="/usr/bin/clang++"
fi
if [ ! -x "${CXX}" ]; then
    error "C++ compiler is required to install Sofin"
    exit 1
fi


shell_configuration=$(${CAT_BIN} <<EOF
if [ "\$(${ID_BIN} -u)" = "0" ]; then
    if [ -e "/etc/profile_sofin" ]; then
        . /etc/profile_sofin
    fi
    trap "source /etc/profile_sofin" USR2
else
    if [ -e \$HOME/.profile ]; then
        . \$HOME/.profile
    fi
    trap "source \$HOME/.profile" USR2
fi
export SHELL_PID="\$\$"
EOF
)


update_env_files () {
    env_files="/etc/zshenv /etc/bashrc /etc/profile"
    for i in ${env_files}; do
        if [ -f "${i}" ]; then
            ${GREP_BIN} -q "SHELL_PID" "${i}"
            if [ $? -eq 0 ]; then
                continue
            else
                echo "Updating environment file: ${i}"
                echo "${shell_configuration}" >> "${i}"
                check_command_result $?
            fi
        else
            echo "Creating environment file: ${i}"
            echo "${shell_configuration}" >> "${i}"
            check_command_result $?
        fi
    done
}


# create_user_symlinks () {
#     if [ ! -d "${HOME_DIR}" ]; then
#         echo "Creating ${HOME_DIR} directory."
#         ${MKDIR_BIN} "${HOME_DIR}"
#         check_command_result $?
#     fi

#     CWD="$(pwd)"
#     cd /home

#     for i in *; do
#         uid="$(id -u $i 2>/dev/null)"
#         if [ ! $uid ]; then
#             continue
#         fi
#         if [ ! -L "${HOME_DIR}${uid}" ]; then
#             echo "Creating symlink ${HOME_DIR}${uid} -> /home/${i}."
#             ${LN_BIN} -s "/home/${i}" "${HOME_DIR}${uid}"
#             check_command_result $?
#         fi
#     done

#     cd "${CWD}"
# }


install_base () {
    build_natives

    if [ "${INSTALL}" = "YES" ]; then
        check_root
        ${RM_BIN} -rf "/usr/bin/sofin"
        if [ "$(uname)" != "Darwin" ]; then
            ${RM_BIN} -rf "/usr/bin/sofin-rpp"
        fi
        ${RM_BIN} -rf "/usr/bin/sofin-version-utility"
        ${RM_BIN} -rf "/usr/bin/sofin-miliseconds"
        ${RM_BIN} -rf "/etc/${CONF_FILE}"
        install_sofin
    fi
    ${MKDIR_BIN} -p /Software/.cache
}


build_natives () {
    if [ -x "${CXX}" ]; then
        echo "C++ compiler available. Using: ${CXX}"

        if [ "$(uname)" != "Darwin" ]; then
            echo "Building patcher"
            ${CXX} -Os -fPIC src/sofin-rpath-patcher.cc -o bin/sofin-rpp
            check_command_result $?
        fi

        echo "Building sofin_miliseconds"
        ${CXX} -Os -fPIC src/sofin_miliseconds.cc -o bin/sofin-miliseconds
        check_command_result $?

        echo "Building version utility"
        ${CXX} -Os -fPIC src/sofin-version-utility.cc -o bin/sofin-version-utility
        check_command_result $?
    else
        error "C++ compiler is required to continue"
        exit 1
    fi
}


install_sofin () {
    ${CP_BIN} "src/${CONF_FILE}" "/etc/${CONF_FILE}"
    check_command_result $?
    if [ "$(uname)" != "Darwin" ]; then
        ${CP_BIN} "bin/sofin-rpp" /usr/bin/sofin-rpp
        check_command_result $?
    fi
    ${CP_BIN} "bin/sofin-version-utility" /usr/bin/sofin-version-utility
    check_command_result $?
    ${CP_BIN} "bin/sofin-miliseconds" /usr/bin/sofin-miliseconds
    check_command_result $?
    ${CP_BIN} "src/sofin.sh" /usr/bin/sofin
    check_command_result $?

    sofin_version=$(${CAT_BIN} src/sofin.sh | ${GREP_BIN} VERSION= | ${AWK_BIN} '{print $2}')
    echo "Sofin installed on: ${SYSTEM_NAME} $(bin/sofin-version-utility) with ${sofin_version}"
}


update_env_files
install_base
