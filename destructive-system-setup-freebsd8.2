#!/bin/sh

if [ ! -e $(pwd)/config ]; then
    error "Unable to find config: $(pwd)/config"
    exit
fi
. $(pwd)/config

note "Installing base in ${SOFTWARE_DIR}"
$DINSTAPP base

if [ ! "$($UNAME_BIN)" = "FreeBSD" ]; then
    note "This script is designed to be executed on FreeBSD 8.x systems only."
    exit 1
fi

RMLIST="/media /mnt /COPYRIGHT /etc/bluetooth /etc/mail /etc/ntp /etc/ppp /etc/skel /etc/X11 /etc/csh.* /etc/ftpusers /etc/hosts.lpd /etc/mail.rc /usr/sbin/sendmail /usr/bin/mail /var/mail"

for i in ${RMLIST}; do
   debug "Removing: $i"
   $RM_BIN -rf "$i"
done

note "Some touches and removes from beginning. Shot first, questions later."
$TOUCH_BIN /var/log/console.log
$RM_BIN -rf /home

note "Copying ${PREFILES} to /etc"
$CP_BIN -r ${PREFILES} /etc

note "Filling additional configurations"
echo "Enter hostname:"
read HOSTNAME
echo "hostname=\"$HOSTNAME\"" >> $RC_CONF_FILE

note "Setting interfaces.."
for interface in $($IFCONFIG_BIN -l); do
    if [ ! "$interface" = "lo0" ]; then
        echo "ifconfig_${interface}=\"DHCP\"" >> $RC_CONF_FILE
    fi
done


note "Updating passwd cache database"
$PWD_MKDB_BIN -p /etc/master.passwd

note "Setting PATH & LDDIR"
echo $($SYSTEM_GET_SHELL_PATH) >> /etc/profile
echo "" >> /etc/profile
echo $($SYSTEM_GET_SHELL_LDLIB) >> /etc/profile
echo "" >> /etc/profile
. /etc/profile

note "Setting zshrc to autoload profile"
echo "source /etc/profile" >> /etc/zshrc

note "Updating shells"
echo "$(which zsh)" >> /etc/shells

note "Adding default users"
for user in $SYSUSERS; do
    if [ ! -d /home/${user} ]; then
        $MKDIR_BIN -p /home/${user}
    fi
    $PW_BIN useradd $user -u $(get "SYSUSERS" "${user}") -d /home/${user} -g $SYSGROUP -s "$(which zsh)"
    $TOUCH_BIN /home/${user}/.zshrc
    $CHOWN_BIN -R ${user}:$SYSGROUP /home/${user}
done

note "Updating ssh config"
echo "" >> /etc/ssh/ssh_config
echo "Host verknowsys.com git.verknowsys.com fiend.pl" >> /etc/ssh/ssh_config
echo "Port $DEFAULT_SSH_PORT" >> /etc/ssh/ssh_config

note "Getting ServeD from git repository"
cd /tmp
if [ -d /tmp/ServeD ]; then
    $RM_BIN -rf /opt/ServeD
    cd /tmp/ServeD
    git pull origin master
    $CP_BIN -r /tmp/ServeD /opt
else
    git clone ssh://tunemates@git.verknowsys.com/git/ServeD.git
    $CP_BIN -r /tmp/ServeD /opt
fi

note "Building ServeD"
cd /opt/ServeD
sbt update
sbt install

note "Updating FreeBSD release"
$FREEBSDUPDATE_BIN fetch >> $LOG
$FREEBSDUPDATE_BIN install >> $LOG

note "Setting time zone"
$TZSETUP_BIN

note "Restarting system services"
for service in ${SERVICES}; do
    service $service restart 2>> $LOG >> $LOG &
done

note "Done"
exit
